
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ردیاب عادت</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      padding: 20px;
      background: #f2f2f2;
      color: #333;
    }
    h2, h3 {
      text-align: center;
    }
    .counter {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .pill {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px 16px;
      border-radius: 30px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      position: relative;
    }
    .badge {
      background: red;
      color: white;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      position: absolute;
      top: -8px;
      left: -8px;
    }
    .sleep-input {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    button {
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ردیاب رفتارهای منفی</h2>
  <div class="counter">
    <div class="pill" onclick="log('🚬')">🚬 <span class="badge" id="cigCount">0</span></div>
    <div class="pill" onclick="log('🔞/خودارضایی')">🔞 <span class="badge" id="pornCount">0</span></div>
  </div>

  <div class="sleep-input">
    <label>🛌 ساعت خواب: </label>
    <input type="time" id="sleepTime">
    <button onclick="logSleep()">ثبت</button>
  </div>

  <div>
    <h3>📋 لاگ امروز</h3>
    <table>
      <thead><tr><th>ساعت</th><th>رفتار</th><th>حذف</th></tr></thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>

  <div>
    <h3>📊 خلاصه روزهای اخیر</h3>
    <table>
      <thead><tr><th>تاریخ</th><th>سیگار</th><th>پورن</th><th>خواب</th></tr></thead>
      <tbody id="summaryLogBody"></tbody>
    </table>
  </div>

<script>
window.addEventListener('DOMContentLoaded', function () {
  const logBody = document.getElementById("logBody");
  const summaryLogBody = document.getElementById("summaryLogBody");
  let logs = JSON.parse(localStorage.getItem("negativeLogsMinimal") || "[]");

  function save() {
    localStorage.setItem("negativeLogsMinimal", JSON.stringify(logs));
    render();
    renderSummaryTable();

  // 🔔 اعلان روزانه در ساعت ۹ شب
  if (Notification && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function showDailyReminder() {
    if (Notification && Notification.permission === "granted") {
      new Notification("یادآوری", {
        body: "یادت نره رفتارهای امروز رو ثبت کنی",
        icon: "icon-192.png"
      });
    }
  }

  setInterval(() => {
    const now = new Date();
    if (now.getHours() === 21 && now.getMinutes() === 0) {
      showDailyReminder();
    }
  }, 60000); // چک هر یک دقیقه

  }

  window.log = function(type) {
    const fullDate = new Date().toISOString();
    logs.push({ fullDate, type });
    save();
  }

  window.logSleep = function() {
    const t = document.getElementById("sleepTime").value;
    if (t) {
      const fullDate = new Date().toISOString().slice(0,10) + "T" + t + ":00";
      logs.push({ fullDate, type: "🛌 ساعت خواب" });
      save();
      document.getElementById("sleepTime").value = "";
    }
  }

  window.deleteRow = function(fullDate, type) {
    logs = logs.filter(entry => !(entry.fullDate === fullDate && entry.type === type));
    save();
  }

  function render() {
    const now = new Date();
    const todayLogs = logs.filter(entry => {
      const d = new Date(entry.fullDate);
      if (d.getHours() < 6) d.setDate(d.getDate() - 1);
      return d.toDateString() === now.toDateString();
    });

    document.getElementById('cigCount').innerText = todayLogs.filter(e => e.type === '🚬').length;
    document.getElementById('pornCount').innerText = todayLogs.filter(e => e.type === '🔞/خودارضایی').length;

    logBody.innerHTML = "";
    todayLogs.reverse().forEach(entry => {
      const time = new Date(entry.fullDate).toTimeString().slice(0, 5);
      logBody.innerHTML += `<tr>
        <td>${time}</td>
        <td>${entry.type}</td>
        <td><button onclick="deleteRow('${entry.fullDate}', '${entry.type}')">🗑</button></td>
      </tr>`;
    });
  }

  function renderSummaryTable() {
    const days = {};
    logs.forEach(entry => {
      const d = new Date(entry.fullDate);
      if (d.getHours() < 6) d.setDate(d.getDate() - 1);
      const dateKey = d.toISOString().slice(0, 10);
      if (!days[dateKey]) days[dateKey] = { cig: 0, porn: 0, sleep: "-" };
      if (entry.type === '🚬') days[dateKey].cig++;
      if (entry.type === '🔞/خودارضایی') days[dateKey].porn++;
      if (entry.type === '🛌 ساعت خواب') days[dateKey].sleep = d.toTimeString().slice(0, 5);
    });

    const sorted = Object.entries(days).sort((a,b) => b[0].localeCompare(a[0])).slice(0, 10);
    summaryLogBody.innerHTML = "";
    sorted.forEach(([date, data]) => {
      summaryLogBody.innerHTML += `<tr>
        <td>${date}</td>
        <td>${data.cig}</td>
        <td>${data.porn}</td>
        <td>${data.sleep}</td>
      </tr>`;
    });
  }

  render();
  renderSummaryTable();

  // 🔔 اعلان روزانه در ساعت ۹ شب
  if (Notification && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function showDailyReminder() {
    if (Notification && Notification.permission === "granted") {
      new Notification("یادآوری", {
        body: "یادت نره رفتارهای امروز رو ثبت کنی",
        icon: "icon-192.png"
      });
    }
  }

  setInterval(() => {
    const now = new Date();
    if (now.getHours() === 21 && now.getMinutes() === 0) {
      showDailyReminder();
    }
  }, 60000); // چک هر یک دقیقه

});
</script>
</body>
</html>
